<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HQ æ’çƒå°‘å¹´ç·¨éšŠå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --primary: #ff9800; --secondary: #4CAF50; --bg: #f0f2f5; }
        body { font-family: 'Microsoft JhengHei', sans-serif; background: var(--bg); margin: 0; display: flex; overflow: hidden; height: 100vh; flex-direction: row; }

        /* éŸ¿æ‡‰å¼ä½ˆå±€ */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            #sidebar { width: 100% !important; height: 50vh !important; border-right: none !important; border-bottom: 2px solid #ddd; }
            #main { height: auto !important; }
            .deck-grid { grid-template-columns: repeat(4, 1fr) !important; }
        }

        /* å´é‚Šæœå°‹èˆ‡é è¦½ */
        #sidebar { width: 350px; height: 100vh; display: flex; flex-direction: column; background: white; border-right: 2px solid #ddd; flex-shrink: 0; }
        .search-box { padding: 15px; background: #fff; }
        #searchInput { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        #resultList { flex-grow: 1; overflow-y: auto; }
        .card-item { padding: 12px; border-bottom: 1px solid #f9f9f9; cursor: pointer; font-size: 14px; }
        .card-item:hover { background: #fff3e0; }

        /* é è¦½é¢æ¿ */
        .preview-panel { height: 200px; background: #fafafa; border-top: 1px solid #eee; display: flex; padding: 10px; gap: 10px; flex-shrink: 0; }
        #previewImg { width: 110px; height: 160px; object-fit: cover; border-radius: 5px; background: #eee; display: none; }
        .preview-info { flex-grow: 1; font-size: 13px; overflow-y: auto; }

        /* ä¸»ç·¨éšŠå€ */
        #main { flex-grow: 1; display: flex; flex-direction: column; padding: 15px; height: 100vh; box-sizing: border-box; }
        .controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        button { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; font-size: 13px; }
        
        .deck-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 6px; background: white; padding: 10px; border-radius: 8px; }
        .deck-slot { aspect-ratio: 2/3; border: 1px dashed #ccc; border-radius: 4px; position: relative; background: #fdfdfd; overflow: visible; }
        .deck-slot img { width: 100%; height: 100%; object-fit: cover; border-radius: 3px; }
        .remove-btn { position: absolute; top: -5px; right: -5px; background: #ff4444; color: white; width: 18px; height: 18px; border-radius: 50%; font-size: 12px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 5; }

        /* æç¤ºèˆ‡å½ˆçª— */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; z-index: 9999; display: none; }
        #qtyControl { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 30px rgba(0,0,0,0.3); display: none; z-index: 100; text-align: center; }
    </style>
</head>
<body>

<div id="toast" class="toast"></div>

<div id="sidebar">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹åç¨±/æŠ€èƒ½/ç·¨è™Ÿ..." oninput="handleSearch()">
    </div>
    <div id="resultList"></div>
    <div class="preview-panel">
        <img id="previewImg" src="">
        <div class="preview-info">
            <b id="prevName">è«‹é¸å–å¡ç‰‡</b><br><br>
            <span id="prevSkill" style="color:#666"></span>
        </div>
    </div>
</div>

<div id="main">
    <h3 style="margin:5px 0;">æˆ‘çš„ç‰Œçµ„ (<span id="deckCount">0</span>/40)</h3>
    <div class="controls">
        <button style="background:#2196F3;" onclick="copyDeckCode()">è¤‡è£½ä»£ç¢¼</button>
        <button style="background:#607d8b;" onclick="importDeckCode()">è²¼ä¸Šä»£ç¢¼</button>
        <button style="background:var(--secondary);" onclick="exportDeck()">ä¸‹è¼‰JSON</button>
        <button style="background:#555;" onclick="document.getElementById('importFile').click()">è®€å–JSON</button>
        <button style="background:#9c27b0;" onclick="exportAsImage()">è¼¸å‡ºåœ–ç‰‡</button>
        <button style="background:#ff4444;" onclick="if(confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')) { currentDeck=[]; updateDeckUI(); }">æ¸…ç©º</button>
        <input type="file" id="importFile" style="display:none" accept=".json" onchange="importDeck(event)">
    </div>
    <div class="deck-grid" id="deckGrid"></div>
</div>

<div id="qtyControl">
    <b id="qtyTitle"></b><br>
    æ•¸é‡: <input type="number" id="cardQty" value="1" min="1" max="40" style="width:60px; font-size:18px; margin:15px;">
    <br>
    <button onclick="addSelectedToDeck()" style="background:var(--secondary); padding:10px 20px;">ç¢ºèªåŠ å…¥</button>
    <button onclick="document.getElementById('qtyControl').style.display='none'" style="background:#888; padding:10px 20px;">å–æ¶ˆ</button>
</div>

<script>
    let allCards = [];
    let currentDeck = [];
    let selectedTempCard = null;

    function showToast(msg, duration = 2000) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        if(duration > 0) setTimeout(() => t.style.display = 'none', duration);
    }

    async function init() {
        const fetchCSV = (url) => new Promise(res => {
            Papa.parse(url, { download: true, header: true, skipEmptyLines: true, complete: r => res(r.data) });
        });
        try {
            const chars = await fetchCSV('characters.csv');
            const events = await fetchCSV('events.csv');
            allCards = [...chars.map(c=>({...c, type:'è§’è‰²'})), ...events.map(e=>({...e, type:'äº‹ä»¶'}))];
            renderResults(allCards.slice(0, 20));
        } catch(e) { showToast("CSV è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆåç¨±"); }
    }

    function handleSearch() {
        const kw = document.getElementById('searchInput').value.toLowerCase();
        const res = kw ? allCards.filter(c => Object.values(c).some(v => String(v).toLowerCase().includes(kw))) : allCards.slice(0,20);
        renderResults(res);
    }

    function renderResults(results) {
        document.getElementById('resultList').innerHTML = results.map(c => `
            <div class="card-item" onclick="updatePreview('${c.ID}')">
                [${c.type}] ${c.ID} ${c.å¡å}
            </div>
        `).join('');
    }

    function updatePreview(id) {
        const c = allCards.find(card => card.ID === id);
        if(!c) return;
        selectedTempCard = c;
        const img = document.getElementById('previewImg');
        img.src = c.åœ–ç‰‡ || ''; img.style.display = 'block';
        document.getElementById('prevName').innerText = `[${c.ID}] ${c.å¡å}`;
        document.getElementById('prevSkill').innerText = c.æŠ€èƒ½ || 'ç„¡æŠ€èƒ½æè¿°';
        document.getElementById('qtyTitle').innerText = `[${c.ID}] ${c.å¡å}`;
        document.getElementById('qtyControl').style.display = 'block';
    }

    function addSelectedToDeck() {
        const qty = parseInt(document.getElementById('cardQty').value);
        for(let i=0; i<qty; i++) if(currentDeck.length < 40) currentDeck.push(selectedTempCard);
        updateDeckUI();
        document.getElementById('qtyControl').style.display = 'none';
    }

    function updateDeckUI() {
        const grid = document.getElementById('deckGrid');
        document.getElementById('deckCount').innerText = currentDeck.length;
        grid.innerHTML = "";
        for(let i=0; i<40; i++) {
            const card = currentDeck[i];
            const slot = document.createElement('div');
            slot.className = 'deck-slot';
            if(card) {
                slot.innerHTML = `<img src="${card.åœ–ç‰‡}" title="${card.å¡å}"><button class="remove-btn" onclick="removeFromDeck(${i})">Ã—</button>`;
            }
            grid.appendChild(slot);
        }
    }

    function removeFromDeck(index) { currentDeck.splice(index, 1); updateDeckUI(); }

    // JSON åŠŸèƒ½ï¼šåƒ…å­˜ ID
    function exportDeck() {
        if(!currentDeck.length) return alert("ç‰Œçµ„ç‚ºç©º");
        const ids = currentDeck.map(c => c.ID);
        const blob = new Blob([JSON.stringify(ids)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = "deck.json"; a.click();
    }

    function importDeck(event) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const ids = JSON.parse(e.target.result);
                currentDeck = ids.map(id => allCards.find(c => c.ID === id)).filter(Boolean);
                updateDeckUI();
                showToast("JSON å°å…¥æˆåŠŸ");
            } catch(err) { alert("ç„¡æ•ˆçš„ JSON æª”æ¡ˆ"); }
        };
        reader.readAsText(event.target.files[0]);
        event.target.value = '';
    }

    function copyDeckCode() {
        if(!currentDeck.length) return;
        navigator.clipboard.writeText(currentDeck.map(c=>c.ID).join(',')).then(()=>showToast("ä»£ç¢¼å·²è¤‡è£½"));
    }

    function importDeckCode() {
        const code = prompt("è²¼ä¸Šä»£ç¢¼ (IDç”¨é€—è™Ÿéš”é–‹):");
        if(code) {
            currentDeck = code.split(/[, ]+/).map(id => allCards.find(c => c.ID.trim() === id.trim())).filter(Boolean);
            updateDeckUI();
        }
    }

    function exportAsImage() {
        showToast("æ­£åœ¨ç”¢ç”Ÿåœ–ç‰‡...", 0);
        const grid = document.getElementById('deckGrid');
        const timeout = setTimeout(() => { document.getElementById('toast').style.display='none'; alert("ç”¢åœ–è¶…æ™‚ï¼Œè«‹æª¢æŸ¥åœ–ç‰‡ç¶²å€æˆ–é•·æŒ‰åœ–ç‰‡å„²å­˜"); }, 10000);

        html2canvas(grid, { useCORS: true, scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
            clearTimeout(timeout);
            const a = document.createElement('a');
            a.download = 'hq_deck.png'; a.href = canvas.toDataURL("image/png"); a.click();
            showToast("åœ–ç‰‡ä¸‹è¼‰å®Œæˆ");
        }).catch(() => { clearTimeout(timeout); showToast("ç”¢åœ–å¤±æ•—"); });
    }

    init();
</script>
</body>
</html>
