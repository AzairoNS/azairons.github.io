<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HQ æ’çƒå°‘å¹´ç·¨éšŠå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --primary: #ff9800; --secondary: #4CAF50; --bg: #f0f2f5; }
        body { font-family: 'Microsoft JhengHei', sans-serif; background: var(--bg); margin: 0; display: flex; overflow: hidden; height: 100vh; flex-direction: row; }

        /* éŸ¿æ‡‰å¼ä½ˆå±€ï¼šæ‰‹æ©Ÿç‰ˆæ”¹ç‚ºå‚ç›´æ’åˆ— */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            #sidebar { width: 100% !important; height: 50vh !important; border-right: none !important; border-bottom: 2px solid #ddd; }
            #main { height: auto !important; }
            .deck-grid { grid-template-columns: repeat(4, 1fr) !important; }
        }

        /* å´é‚Šæœå°‹æ¬„ */
        #sidebar { width: 350px; height: 100vh; display: flex; flex-direction: column; background: white; border-right: 2px solid #ddd; flex-shrink: 0; }
        .search-box { padding: 15px; background: #fff; z-index: 10; }
        #searchInput { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        #resultList { flex-grow: 1; overflow-y: auto; background: #fff; }
        .card-item { padding: 12px; border-bottom: 1px solid #f9f9f9; cursor: pointer; font-size: 14px; }
        .card-item:hover { background: #fff3e0; }

        /* å›ºå®šé è¦½å€ */
        .preview-panel { height: 220px; background: #fafafa; border-top: 1px solid #eee; display: flex; padding: 10px; gap: 10px; flex-shrink: 0; }
        #previewImg { width: 120px; height: 170px; object-fit: cover; border-radius: 5px; background: #eee; flex-shrink: 0; }
        .preview-info { flex-grow: 1; font-size: 13px; overflow-y: auto; }

        /* å³å´ç·¨éšŠå€ */
        #main { flex-grow: 1; display: flex; flex-direction: column; padding: 15px; height: 100vh; box-sizing: border-box; }
        .controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        button { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; font-size: 13px; }
        
        .deck-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 8px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .deck-slot { aspect-ratio: 2/3; border: 1px dashed #ccc; border-radius: 4px; position: relative; background: #fdfdfd; }
        .deck-slot img { width: 100%; height: 100%; object-fit: cover; border-radius: 3px; }
        .remove-btn { position: absolute; top: -5px; right: -5px; background: #ff4444; width: 18px; height: 18px; border-radius: 50%; font-size: 12px; display: flex; align-items: center; justify-content: center; }

        /* æ‰¹é‡åŠ å…¥é¢æ¿ */
        #qtyControl { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 30px rgba(0,0,0,0.3); display: none; z-index: 100; text-align: center; }
        #qtyControl input { width: 60px; padding: 8px; margin: 10px; font-size: 18px; text-align: center; }

	/* è‡ªå‹•æ¶ˆå¤±çš„æç¤ºæ¡† */
	.toast {
	    position: fixed;
	    top: 20px;
	    left: 50%;
	    transform: translateX(-50%);
	    background: rgba(0, 0, 0, 0.8);
	    color: white;
	    padding: 12px 24px;
	    border-radius: 30px;
	    z-index: 9999;
	    display: none; /* é è¨­éš±è— */
	    font-size: 14px;
	    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
	}
    </style>
</head>
<body>
<div id="toast" class="toast">æ­£åœ¨ç”¢ç”Ÿåœ–ç‰‡ï¼Œè«‹ç¨å€™...</div>
<div id="sidebar">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹åç¨±/æŠ€èƒ½/ç·¨è™Ÿ..." oninput="handleSearch()">
    </div>
    <div id="resultList"></div>
    <div class="preview-panel" id="sidePreview">
        <img id="previewImg" src="" style="display:none">
        <div class="preview-info">
            <b id="prevName">è«‹é¸å–å¡ç‰‡</b><br>
            <span id="prevSkill" style="color:#666"></span>
        </div>
    </div>
</div>

<div id="main">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:5px 0;">æˆ‘çš„ç‰Œçµ„ (<span id="deckCount">0</span>/40)</h3>
    </div>
    <div class="controls">
        <button style="background:#2196F3;" onclick="copyDeckCode()">è¤‡è£½ä»£ç¢¼</button>
        <button style="background:#607d8b;" onclick="importDeckCode()">è²¼ä¸Šä»£ç¢¼</button>
        <button style="background:var(--secondary);" onclick="exportDeck()">ä¸‹è¼‰JSON</button>
        <button style="background:#9c27b0;" onclick="exportAsImage()">è¼¸å‡ºåœ–ç‰‡</button>
        <button style="background:#ff4444;" onclick="if(confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')) { currentDeck=[]; updateDeckUI(); }">æ¸…ç©º</button>
    </div>
    <div class="deck-grid" id="deckGrid"></div>
</div>

<div id="qtyControl">
    <b id="qtyTitle"></b><br>
    æ•¸é‡: <input type="number" id="cardQty" value="1" min="1" max="40">
    <br>
    <button onclick="addSelectedToDeck()" style="background:var(--secondary); padding:10px 20px;">ç¢ºèªåŠ å…¥</button>
    <button onclick="document.getElementById('qtyControl').style.display='none'" style="background:#888;">å–æ¶ˆ</button>
</div>

<script>
    let allCards = [];
    let currentDeck = [];
    let selectedTempCard = null;

    async function init() {
        const fetchCSV = (url) => new Promise(res => {
            Papa.parse(url, { download: true, header: true, complete: r => res(r.data) });
        });
        const chars = await fetchCSV('characters.csv');
        const events = await fetchCSV('events.csv');
        allCards = [...chars.map(c=>({...c, type:'è§’è‰²'})), ...events.map(e=>({...e, type:'äº‹ä»¶'}))];
        renderResults(allCards.slice(0, 20)); // é è¨­é¡¯ç¤ºå‰20å¼µ
    }

    function handleSearch() {
        const kw = document.getElementById('searchInput').value.toLowerCase();
        if(!kw) return renderResults(allCards.slice(0,20));
        const filtered = allCards.filter(c => 
            (c.ID && c.ID.toLowerCase().includes(kw)) || 
            (c.å¡å && c.å¡å.toLowerCase().includes(kw)) ||
            (c.å­¸æ ¡ && c.å­¸æ ¡.toLowerCase().includes(kw)) ||
            (c.å¹´ç´š && c.å¹´ç´š.toLowerCase().includes(kw)) ||
            (c.å´—ä½ && c.å´—ä½.toLowerCase().includes(kw)) ||
            (c.æŠ€èƒ½ç™¼å‹•ä½ç½® && c.æŠ€èƒ½ç™¼å‹•ä½ç½®.toLowerCase().includes(kw)) ||
            (c.æŠ€èƒ½ && c.æŠ€èƒ½.toLowerCase().includes(kw)) ||
            (c.å¸¸è¦‹ç¨±å‘¼ && c.å¸¸è¦‹ç¨±å‘¼.toLowerCase().includes(kw)) ||
            (c.é—œéµå­— && c.é—œéµå­—.toLowerCase().includes(kw)) 
        );
        renderResults(filtered);
    }

    function renderResults(results) {
        const list = document.getElementById('resultList');
        list.innerHTML = results.map(c => `
            <div class="card-item" onclick="updatePreview('${c.ID}')">
                [${c.type}] ${c.ID} ${c.å¡å}
            </div>
        `).join('');
    }

    function updatePreview(id) {
        const c = allCards.find(card => card.ID === id);
        if(!c) return;
        selectedTempCard = c;
        const img = document.getElementById('previewImg');
        img.src = c.åœ–ç‰‡ || '';
        img.style.display = 'block';
        document.getElementById('prevName').innerText = `[${c.ID}] ${c.å¡å}`;
        document.getElementById('prevSkill').innerText = c.æŠ€èƒ½ || 'ç„¡æŠ€èƒ½æè¿°';
        
        // é»æ“Šç¬¬äºŒæ¬¡æˆ–é»æ“Šé è¦½å€å¯è§¸ç™¼æ‰¹é‡åŠ å…¥
        document.getElementById('qtyTitle').innerText = `[${c.ID}] ${c.å¡å}`;
        document.getElementById('qtyControl').style.display = 'block';
    }

    function addSelectedToDeck() {
        const qty = parseInt(document.getElementById('cardQty').value);
        for(let i=0; i<qty; i++) {
            if(currentDeck.length < 40) currentDeck.push(selectedTempCard);
        }
        updateDeckUI();
        document.getElementById('qtyControl').style.display = 'none';
    }

    function updateDeckUI() {
        const grid = document.getElementById('deckGrid');
        document.getElementById('deckCount').innerText = currentDeck.length;
        grid.innerHTML = "";
        // è£œæ»¿ 40 æ ¼
        for(let i=0; i<40; i++) {
            const card = currentDeck[i];
            const slot = document.createElement('div');
            slot.className = 'deck-slot';
            if(card) {
                slot.innerHTML = `<img src="${card.åœ–ç‰‡}"><button class="remove-btn" onclick="removeFromDeck(${i})">Ã—</button>`;
            }
            grid.appendChild(slot);
        }
    }

    function removeFromDeck(index) {
        currentDeck.splice(index, 1);
        updateDeckUI();
    }

    // æ‰‹æ©Ÿå‹å–„ï¼šè¤‡è£½æ–‡å­—ä»£ç¢¼
    function copyDeckCode() {
        if(currentDeck.length === 0) return alert("ç‰Œçµ„æ˜¯ç©ºçš„");
        const code = currentDeck.map(c => c.ID).join(',');
        navigator.clipboard.writeText(code).then(() => alert("ä»£ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼"));
    }

    function importDeckCode() {
        const code = prompt("è«‹è²¼ä¸Šç‰Œçµ„ä»£ç¢¼ (IDä»¥é€—è™Ÿéš”é–‹):");
        if(!code) return;
        const ids = code.split(',');
        currentDeck = ids.map(id => allCards.find(c => c.ID.trim() === id.trim())).filter(Boolean);
        updateDeckUI();
    }

    function exportDeck() {
        const blob = new Blob([JSON.stringify(currentDeck)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = "hq_deck.json"; a.click();
    }

	// é¡¯ç¤ºæç¤ºè¨Šæ¯çš„å·¥å…·å‡½å¼
	function showToast(message, duration = 2000) {
	    const toast = document.getElementById('toast');
	    toast.innerText = message;
	    toast.style.display = 'block';
    
  	  // å¦‚æœ duration ç‚º 0ï¼Œä»£è¡¨ä¸è‡ªå‹•é—œé–‰ (ç­‰å¾…æ‰‹å‹•é—œé–‰)
	    if (duration > 0) {
      	  	setTimeout(() => {
       	     	toast.style.display = 'none';
    	    }, duration);
    	  }
	}

	function exportAsImage() {
    		// 1. é¡¯ç¤ºã€Œè™•ç†ä¸­ã€ä½†ä¸è‡ªå‹•é—œé–‰
    		showToast("æ­£åœ¨ç”¢ç”Ÿåœ–ç‰‡ï¼Œè«‹ç¨å€™...", 0);

    		const grid = document.getElementById('deckGrid');
    
    		// ä½¿ç”¨ requestAnimationFrame ç¢ºä¿æç¤ºæ¡†å·²ç¶“æ¸²æŸ“å‡ºä¾†
    		requestAnimationFrame(() => {
        		html2canvas(grid, { 
           		useCORS: true, 
            		scale: 2,
            		backgroundColor: "#ffffff" // ç¢ºä¿èƒŒæ™¯æ˜¯ç™½è‰²
        		}).then(canvas => {
            		const link = document.createElement('a');
            		link.download = 'my_hq_deck.png';
            		link.href = canvas.toDataURL("image/png");
            		link.click();

            	// 2. ä¸‹è¼‰è§¸ç™¼å¾Œï¼Œå°‡æç¤ºæ”¹ç‚ºã€Œå®Œæˆã€ä¸¦åœ¨ 2 ç§’å¾Œæ¶ˆå¤±
            		showToast("åœ–ç‰‡ä¸‹è¼‰å®Œæˆï¼");
        		}).catch(err => {
            			console.error(err);
            		showToast("åœ–ç‰‡ç”¢ç”Ÿå¤±æ•—ï¼Œè«‹é‡è©¦");
        		});
    		});
	}

    init();
    updateDeckUI();
</script>

</body>
</html>